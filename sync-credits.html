<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sync Credits - NexusAI</title>
    <style>
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu,
          Cantarell, sans-serif;
        max-width: 600px;
        margin: 50px auto;
        padding: 20px;
        background: #1a1a1a;
        color: #fff;
      }
      .container {
        background: #2a2a2a;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      }
      h1 {
        color: #ff6b35;
        margin-bottom: 10px;
      }
      p {
        color: #aaa;
        line-height: 1.6;
      }
      button {
        background: #ff6b35;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
        margin-top: 20px;
        width: 100%;
      }
      button:hover {
        background: #ff8555;
      }
      button:disabled {
        background: #555;
        cursor: not-allowed;
      }
      .result {
        margin-top: 20px;
        padding: 15px;
        border-radius: 6px;
        display: none;
      }
      .result.success {
        background: #1a4d2e;
        border: 1px solid #2d7a4f;
        color: #7fff7f;
      }
      .result.error {
        background: #4d1a1a;
        border: 1px solid #7a2d2d;
        color: #ff7f7f;
      }
      .loading {
        text-align: center;
        color: #ff6b35;
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîÑ Sync Credits</h1>
      <p>
        If you purchased credits but they didn't appear automatically, click the
        button below to manually sync your payment from Stripe.
      </p>
      <p>
        <strong>Note:</strong> You must be logged into NexusAI for this to work.
      </p>

      <button id="syncBtn" onclick="syncPayment()">Sync My Credits</button>

      <div class="loading" id="loading">
        <p>‚è≥ Syncing payment...</p>
      </div>

      <div class="result" id="result"></div>
    </div>

    <script>
      async function syncPayment() {
        const btn = document.getElementById('syncBtn')
        const loading = document.getElementById('loading')
        const result = document.getElementById('result')

        btn.disabled = true
        loading.style.display = 'block'
        result.style.display = 'none'

        try {
          // Get auth token from localStorage
          const nexusaiAuth = localStorage.getItem('nexusai_auth')
          const dashboardAuth = localStorage.getItem(
            'vpn-enterprise-auth-storage',
          )

          let token = null

          if (nexusaiAuth) {
            const auth = JSON.parse(nexusaiAuth)
            token = auth.token
          } else if (dashboardAuth) {
            const auth = JSON.parse(dashboardAuth)
            token = auth.token
          }

          if (!token) {
            throw new Error(
              'Not authenticated. Please log in to NexusAI first.',
            )
          }

          // Call sync endpoint
          const response = await fetch(
            'https://chatbuilds.com/api/v1/billing/sync-payment',
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${token}`,
              },
              credentials: 'include',
            },
          )

          const data = await response.json()

          if (response.ok && data.success) {
            result.className = 'result success'
            result.style.display = 'block'
            result.innerHTML = `
                        <strong>‚úÖ Success!</strong><br>
                        ${data.message}<br>
                        Credits applied: ${data.creditsApplied}<br>
                        Payments processed: ${data.paymentsProcessed}
                    `

            // Refresh the page after 2 seconds
            setTimeout(() => {
              window.location.reload()
            }, 2000)
          } else {
            throw new Error(
              data.error || data.message || 'Failed to sync payment',
            )
          }
        } catch (error) {
          result.className = 'result error'
          result.style.display = 'block'
          result.innerHTML = `
                    <strong>‚ùå Error</strong><br>
                    ${error.message}
                `
        } finally {
          btn.disabled = false
          loading.style.display = 'none'
        }
      }
    </script>
  </body>
</html>
