# ==============================================
# VPN ENTERPRISE - PRODUCTION DOCKER COMPOSE
# ==============================================
# Production-ready setup with security hardening

services:
  # ============================================
  # API SERVER (Production)
  # ============================================
  api:
    build:
      context: ../..
      dockerfile: infrastructure/docker/Dockerfile.api
      target: production
    container_name: vpn-api
    restart: always
    env_file:
      - ../../.env.production
      - ./config/app.prod.env
    environment:
      - NODE_ENV=production
      - PORT=5000
      - POSTGRES_HOST=vpn-postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=platform_db
      - POSTGRES_USER=platform_admin
      - POSTGRES_PASSWORD_FILE=/run/secrets/db_password
      - REDIS_HOST=vpn-redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD_FILE=/run/secrets/redis_password
    secrets:
      - api_key
      - db_password
      - redis_password
    networks:
      - vpn-network
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:5000/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

  # ============================================
  # WEB DASHBOARD (Production)
  # ============================================
  web:
    build:
      context: ../..
      dockerfile: infrastructure/docker/Dockerfile.web
      target: production
    container_name: vpn-web
    restart: always
    env_file:
      - ../../.env.production
      - ./config/app.prod.env
    environment:
      - NODE_ENV=production
      # Used for server-side rendering calls from inside the Docker network.
      - INTERNAL_API_URL=http://api:5000
    networks:
      - vpn-network
    depends_on:
      api:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    healthcheck:
      test:
        [
          'CMD',
          'node',
          '-e',
          "require('http').get('http://127.0.0.1:3000/', (res) => process.exit((res.statusCode||0) < 500 ? 0 : 1)).on('error', () => process.exit(1));",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

  # ============================================
  # POSTGRESQL DATABASE (Production)
  # ============================================
  postgres:
    image: postgres:15-alpine
    container_name: vpn-postgres
    restart: always
    env_file:
      - ../../.env.production
      - ./config/app.prod.env
    environment:
      - POSTGRES_PASSWORD_FILE=/run/secrets/db_password
      - POSTGRES_ADMIN_PASSWORD_FILE=/run/secrets/db_password
      - POSTGRES_DB=platform_db
      - POSTGRES_USER=platform_admin
    secrets:
      - db_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres/init-scripts:/docker-entrypoint-initdb.d:ro
      - ../postgres/postgresql.conf:/etc/postgresql/postgresql.conf:ro
      - postgres_backups:/backups
    networks:
      - vpn-network
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U platform_admin -d platform_db']
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

  # ============================================
  # REDIS (Production)
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: vpn-redis
    restart: always
    command: >
      redis-server
      --requirepass $(cat /run/secrets/redis_password)
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --appendonly yes
    secrets:
      - redis_password
    volumes:
      - redis_data:/data
    networks:
      - vpn-network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    healthcheck:
      test: ['CMD', 'redis-cli', '--no-auth-warning', 'ping']
      interval: 10s
      timeout: 5s
      retries: 3
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

  # ============================================
  # N8N WORKFLOW AUTOMATION (Production)
  # ============================================
  n8n:
    image: n8nio/n8n:latest
    container_name: vpn-n8n
    # n8n runs as a non-root user by default. On some hosts the bind-mounted secret files
    # are root-only, which causes EACCES. Running as root avoids the restart loop.
    # If you prefer non-root, fix the host secret file permissions/ACLs instead.
    user: '0:0'
    restart: always
    env_file:
      - ../../.env.production
      - ./config/app.prod.env
    environment:
      - N8N_ENCRYPTION_KEY_FILE=/run/secrets/n8n_encryption_key
      - DB_POSTGRESDB_PASSWORD_FILE=/run/secrets/db_password
      # Credentials should be provided via ../../.env.production as:
      #   N8N_BASIC_AUTH_USER=...
      #   N8N_BASIC_AUTH_PASSWORD=...
      - EXECUTIONS_PROCESS=main
      - EXECUTIONS_DATA_SAVE_ON_ERROR=all
      - EXECUTIONS_DATA_SAVE_ON_SUCCESS=all
    # NOTE: Docker Compose "secrets" are implemented differently depending on environment.
    # In some setups they end up root-only inside the container, which breaks n8n (runs non-root).
    # Bind-mounting these two files ensures the container user can read them reliably.
    volumes:
      - n8n_data:/home/node/.n8n
      - ./secrets/n8n_encryption_key:/run/secrets/n8n_encryption_key:ro
      - ./secrets/db_password:/run/secrets/db_password:ro
    networks:
      - vpn-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test:
        [
          'CMD',
          'node',
          '-e',
          "require('http').get('http://127.0.0.1:5678/healthz', (res) => process.exit((res.statusCode||0) === 200 ? 0 : 1)).on('error', () => process.exit(1));",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

  # ============================================
  # PYTHON API - FastAPI Service (Production)
  # ============================================
  python-api:
    build:
      context: ../../flask
      dockerfile: Dockerfile
    container_name: vpn-python-api
    restart: always
    env_file:
      - ../../.env.production
      - ./config/app.prod.env
    environment:
      - DB_PASSWORD_FILE=/run/secrets/db_password
      - REDIS_PASSWORD_FILE=/run/secrets/redis_password
      - API_KEY_FILE=/run/secrets/api_key
    secrets:
      - db_password
      - redis_password
      - api_key
    volumes:
      - python_api_data:/app/data
    networks:
      - vpn-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:5001/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'
  # ============================================
  # OLLAMA - AI Model Hosting (Production)
  # ============================================
  ollama:
    image: ollama/ollama:latest
    container_name: vpn-ollama
    restart: always
    volumes:
      - ollama_data:/root/.ollama
    environment:
      - OLLAMA_HOST=0.0.0.0:11434
      # If you need browser access cross-origin, set an explicit value in ../../.env.production
      # and add it to this service's environment.
    networks:
      - vpn-network
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G
        reservations:
          cpus: '2.0'
          memory: 4G
    healthcheck:
      test: ['CMD-SHELL', 'ollama list >/dev/null 2>&1 || exit 1']
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

  # ============================================
  # NEXUSAI (Production)
  # ============================================
  nexusai:
    profiles:
      - nexusai
    build:
      context: ../../apps/nexusAi/chat-to-code-38
      dockerfile: Dockerfile
    container_name: vpn-nexusai
    restart: always
    networks:
      - vpn-network
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

  # ============================================
  # NGINX REVERSE PROXY (Production)
  # ============================================
  nginx:
    image: nginx:alpine
    container_name: vpn-nginx
    restart: always
    ports:
      - '80:80'
      - '443:443'
    volumes:
      - ./nginx/prod/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/prod/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - nginx_logs:/var/log/nginx
    networks:
      - vpn-network
    depends_on:
      - api
      - web
      - python-api
      - n8n
      - ollama
      # Optional; enabled via `--profile nexusai`
      # - nexusai
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    healthcheck:
      test: ['CMD', 'nginx', '-t']
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

networks:
  vpn-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  postgres_data:
    driver: local
  postgres_backups:
    driver: local
  redis_data:
    driver: local
  n8n_data:
    driver: local
  python_api_data:
    driver: local
  ollama_data:
    driver: local
  nginx_logs:
    driver: local

# ==============================================
# DOCKER SECRETS (Production)
# ==============================================
# Secrets are mounted as files inside containers at /run/secrets/
# In production, use external secrets from secret manager
secrets:
  db_password:
    file: ./secrets/db_password
  redis_password:
    file: ./secrets/redis_password
  n8n_encryption_key:
    file: ./secrets/n8n_encryption_key
  api_key:
    file: ./secrets/api_key
